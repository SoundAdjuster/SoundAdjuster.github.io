<html>
  <head>
    <title>Sound Adjuster</title>
    <meta charset="UTF-8">
    <meta name="description" content="Sound Adjusterは複数の音声ファイル（主に効果音）の音量を一括で揃えます。音量は人の感覚に近くなるようラウドネス値を参照します。">
    <link rel="stylesheet" href="style.css">
    <!-- <script src="https://cdn.jsdelivr.net/pyodide/v0.18.0/full/pyodide.js"></script> -->
    <script src='pyodide.js'></script>
  </head>
  <body>
    <h1><a href="https://github.com/SoundAdjuster/SoundAdjuster.github.io/" style="color: black; text-decoration: none;">Sound Adjuster</a></h1>

    <!-- ドラッグ＆ドロップエリア -->
    <div id="dropZone" style="border: 2px dashed #aaa; padding: 20px; text-align: center;">
      ファイルをここにドラッグ＆ドロップ、または
      <input type="file" id="fileInput" accept=".mp3, .wav, .aac, .m4a, .flac, .ogg" multiple hidden>
      <button onclick="document.getElementById('fileInput').click();">ファイルを選択</button>
    </div>

    <!-- 選択されたファイルのリストを表示するエリア -->
    <div id="fileList"></div>

    <!-- ラウドネス値の入力: 大きな増減ボタンを提供する -->
    <div id="loudnessControl">
      <button onclick="changeLoudness(-0.1)">-</button>
      <input type="number" id="loudnessInput" value="-31.5" min="-50" max="0" step="0.1">
      <button onclick="changeLoudness(0.1)">+</button>
      <span id="loudnessPopup" class="popup"> ラウドネス値を指定します(-50~0)。<br> 大きすぎる値は音割れを起こします。</span>
    </div>

    <button id="processBtn" disabled>処理開始</button>

    <script>
      async function loadPyodideAndCheckLibrary() {
          // Pyodideを初期化
          const pyodide = await loadPyodide({
            indexURL : "https://cdn.jsdelivr.net/pyodide/v0.18.0/full/"
          });

          await pyodide.loadPackage('micropip');
          await pyodide.runPythonAsync(`
              import micropip
              await micropip.install('scipy')
              await micropip.install('pyloudnorm-custom-package')
          `);

          window.pyodide = pyodide;
          console.log('Pyodide is available.');

          // ボタンをアクティブにする
          document.getElementById('processBtn').disabled = false;
      }

      loadPyodideAndCheckLibrary();
    </script>

    <script>
    // ページの読み込み時にlocalStorageから値を取得し、入力欄に設定する
    function initialize() {
      var loudnessInput = document.getElementById('loudnessInput');

      // localStorageから値を取得
      var storedLoudness = localStorage.getItem('loudnessValue');

      // 値が存在すれば、その値を入力欄に設定
      if(storedLoudness !== null) {
        loudnessInput.value = storedLoudness;
      }

      // 入力値が変更された時、その値をlocalStorageに保存
      loudnessInput.addEventListener('input', function() {
        localStorage.setItem('loudnessValue', loudnessInput.value);
      });
    }

    if (document.readyState === 'loading') {  // ドキュメントがまだ読み込み中の場合
      document.addEventListener('DOMContentLoaded', initialize);
    } else {  // ドキュメントの読み込みが既に完了している場合
      initialize();
    }
    </script>

    <script>
    // ラウドネス値の増減を行う関数
    function changeLoudness(change) {
      const loudnessInput = document.getElementById('loudnessInput');
      const currentVal = parseFloat(loudnessInput.value);
      const newVal = currentVal + change;

      // 最小値と最大値の範囲内に新しい値を制限する
      if (newVal >= parseFloat(loudnessInput.min) && newVal <= parseFloat(loudnessInput.max)) {
          loudnessInput.value = newVal.toFixed(1); // 値を0.1単位で固定
          localStorage.setItem('loudnessValue', loudnessInput.value);
      }
    }
    </script>


    <script>
   // ファイルの状態を保持するための配列
    let fileArray = [];

    // ドラッグ＆ドロップイベントの設定
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileListContainer = document.getElementById('fileList');

    // ファイルが選択されたときにリストを更新する
    fileInput.addEventListener('change', (e) => {
        addFiles(e.target.files);
        updateFileList();
    });

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.background = '#e1e7ec';
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.background = '';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = '';
        addFiles(e.dataTransfer.files);
        updateFileList();
    });

    // 新しいファイルを既存の配列に追加する関数
    function addFiles(newFiles) {
        for (const file of newFiles) {
            let uniqueName = file.name;
            let duplicateCount = 1; // 重複があった場合にカウントを増やす

            // 既存のファイルと名前が重複しているか確認
            while (fileArray.some(f => f.name === uniqueName)) {
                const extensionIndex = file.name.lastIndexOf('.');
                const namePart = file.name.slice(0, extensionIndex);
                const extensionPart = file.name.slice(extensionIndex);
                uniqueName = `${namePart}(${duplicateCount++})${extensionPart}`;
            }

            // ユニークな名前でファイルオブジェクトを配列に追加
            const fileWithUniqueName = new File([file], uniqueName, { type: file.type });
            fileArray.push(fileWithUniqueName);
        }
    }

    // 選択されたファイルのリストをUIに表示する関数
    function updateFileList() {
        fileListContainer.innerHTML = '';
        const list = document.createElement('ul');

        for (const file of fileArray) {
            const listItem = document.createElement('li');
            listItem.textContent = file.name;
            list.appendChild(listItem);
        }

        fileListContainer.appendChild(list);
    }
    </script>
    <script src="app.js"></script>
  </body>
</html>
